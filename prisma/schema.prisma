generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id                     String                     @id
  name                   String                     @db.Text
  email                  String                     @unique
  emailVerified          Boolean                    @default(false)
  image                  String?                    @db.Text
  createdAt              DateTime                   @default(now())
  updatedAt              DateTime                   @updatedAt
  eventParticipants      EventParticipant[]
  registrationRequests   EventRegistrationRequest[]
  eventStaffInvites      EventStaffInvite[]         @relation("EventStaffInviteCreator")
  eventStaffInviteLinks  EventStaffInviteLink[]     @relation("EventStaffInviteLinkCreator")
  eventStaffJoinRequests EventStaffJoinRequest[]
  eventStaffMemberships  EventStaffMembership[]
  judgeLinks             JudgeAssignment[]
  orgInvites             OrgInvite[]
  orgInviteLinks         OrgInviteLink[]
  orgJoinRequests        OrgJoinRequest[]
  memberships            OrgMembership[]
  eventInviteLinks       EventInviteLink[]          @relation("EventInviteLinkCreator")
  eventEmailInvites      EventEmailInvite[]         @relation("EventEmailInviteCreator")
  scoresGiven            Score[]                    @relation("ScoreJudge")
  sponsorsCreated        Sponsor[]                  @relation("SponsorCreatedBy")
  submissions            Submission[]               @relation("SubmissionAuthor")
  teamAuditActor         TeamAuditLog[]             @relation("TeamAuditActor")
  teamAuditTarget        TeamAuditLog[]             @relation("TeamAuditTarget")
  teamInvitesCreated     TeamInvite[]               @relation("TeamInviteCreator")
  teamJoinRequests       TeamJoinRequest[]
  teamMembers            TeamMember[]
  accounts               Account[]
  sessions               Session[]

  @@map("user")
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?  @db.Text
  userAgent String?  @db.Text
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String    @db.Text
  providerId            String    @db.Text
  userId                String
  accessToken           String?   @db.Text
  refreshToken          String?   @db.Text
  idToken               String?   @db.Text
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?   @db.Text
  password              String?   @db.Text
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("account")
}

model Verification {
  id         String   @id
  identifier String   @db.Text
  value      String   @db.Text
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([identifier(length: 191)])
  @@map("verification")
}

model Organization {
  id                String                @id @default(cuid())
  name              String
  slug              String                @unique
  description       String?
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt
  contactNote       String?
  moderationStatus  ModerationStatus      @default(ACTIVE)
  publicEmail       String?
  publicPhone       String?
  websiteUrl        String?
  coverKey          String?
  logoKey           String?
  allowJoinRequests Boolean               @default(false)
  joinMode          OrgJoinMode           @default(INVITE_ONLY)
  events            Event[]
  invites           OrgInvite[]
  inviteLinks       OrgInviteLink[]
  joinRequests      OrgJoinRequest[]
  memberships       OrgMembership[]
  sponsors          OrganizationSponsor[]
}

model OrgMembership {
  id        String       @id @default(cuid())
  orgId     String
  userId    String
  role      OrgRole      @default(MEMBER)
  createdAt DateTime     @default(now())
  org       Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  user      User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([orgId, userId])
  @@index([userId])
  @@index([orgId])
}

model OrgInvite {
  id              String       @id @default(cuid())
  orgId           String
  email           String
  role            OrgRole      @default(MEMBER)
  token           String       @unique
  status          InviteStatus @default(PENDING)
  message         String?
  createdByUserId String
  createdAt       DateTime     @default(now())
  expiresAt       DateTime?
  creator         User         @relation(fields: [createdByUserId], references: [id], onDelete: Cascade)
  org             Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([email])
  @@index([createdByUserId])
}

model OrgInviteLink {
  id              String       @id @default(cuid())
  orgId           String
  token           String       @unique
  role            OrgRole      @default(MEMBER)
  status          InviteStatus @default(PENDING)
  maxUses         Int?
  uses            Int          @default(0)
  expiresAt       DateTime?
  note            String?
  createdByUserId String
  createdAt       DateTime     @default(now())
  creator         User         @relation(fields: [createdByUserId], references: [id], onDelete: Cascade)
  org             Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([createdByUserId])
}

model OrgJoinRequest {
  id        String            @id @default(cuid())
  orgId     String
  userId    String
  message   String?
  status    JoinRequestStatus @default(PENDING)
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt
  org       Organization      @relation(fields: [orgId], references: [id], onDelete: Cascade)
  user      User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([orgId, userId])
  @@index([orgId])
  @@index([userId])
  @@index([status])
}

model Event {
  id                     String                     @id @default(cuid())
  orgId                  String
  name                   String
  slug                   String
  type                   EventType
  status                 EventStatus                @default(DRAFT)
  heroTitle              String
  heroSubtitle           String?
  locationName           String?                    @default("")   // "UCSD Jacobs Hall"
  locationAddress        String?                    @default("")   // "9500 Gilman Dr, La Jolla, CA 92093"
  locationNotes          String?                    @default("")   // parking, room number, check-in info
  locationMapUrl         String?                    @default("")   // "https://maps.app.goo.gl/1234567890"
  locationLat            Float?                     @default(0)
  locationLng            Float?                     @default(0)
  rulesRich              Json?
  rubricRich             Json?
  startAt                DateTime?
  endAt                  DateTime?
  submitDueAt            DateTime?
  requireImages          Boolean                    @default(false)
  requireVideoDemo       Boolean                    @default(false)
  visibility             EventVisibility            @default(PUBLIC_LISTED)
  joinMode               EventJoinMode              @default(OPEN)
  registrationOpensAt    DateTime?
  registrationClosesAt   DateTime?
  maxTeamSize            Int                        @default(5)
  lockTeamChangesAtStart Boolean                    @default(true)
  allowSelfJoinRequests  Boolean                    @default(true)
  createdAt              DateTime                   @default(now())
  updatedAt              DateTime                   @updatedAt
  moderationStatus       ModerationStatus           @default(ACTIVE)
  coverKey               String?
  allowStaffJoinRequests Boolean                    @default(false)
  staffJoinMode          EventStaffJoinMode         @default(INVITE_ONLY)
  announcements          Announcement[]
  org                    Organization               @relation(fields: [orgId], references: [id], onDelete: Cascade)
  participants           EventParticipant[]
  registrationRequests   EventRegistrationRequest[]
  sponsors               EventSponsor[]
  staffInvites           EventStaffInvite[]
  staffInviteLinks       EventStaffInviteLink[]
  staffJoinRequests      EventStaffJoinRequest[]
  staffMemberships       EventStaffMembership[]
  inviteLinks            EventInviteLink[]
  emailInvites           EventEmailInvite[]
  judgeAssignments       JudgeAssignment[]
  submissions            Submission[]
  submissionSchema       SubmissionSchema?
  teams                  Team[]
  teamAuditLogs          TeamAuditLog[]
  teamInvites            TeamInvite[]
  joinRequests           TeamJoinRequest[]
  awards                 EventAward[]
  awardAssignments       AwardAssignment[]

  @@unique([orgId, slug])
  @@index([orgId])
}

model EventRegistrationRequest {
  id               String                    @id @default(cuid())
  eventId          String
  userId           String
  message          String?
  status           RegistrationRequestStatus @default(PENDING)
  createdAt        DateTime                  @default(now())
  reviewedAt       DateTime?
  reviewedByUserId String?
  event            Event                     @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user             User                      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([eventId, userId])
  @@index([eventId])
  @@index([userId])
  @@index([status])
}

model EventParticipant {
  id              String            @id @default(cuid())
  eventId         String
  userId          String
  status          ParticipantStatus @default(REGISTERED)
  newsletterOptIn Boolean           @default(false)
  contactEmail    String?
  lookingForTeam  Boolean           @default(true)
  trackPreference String?
  skills          Json?
  interests       Json?
  experienceLevel String?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  event           Event             @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([eventId, userId])
  @@index([eventId])
  @@index([userId])
}

model EventStaffMembership {
  id        String         @id @default(cuid())
  eventId   String
  userId    String
  role      EventStaffRole @default(STAFF)
  createdAt DateTime       @default(now())
  event     Event          @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user      User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([eventId, userId])
  @@index([eventId])
  @@index([userId])
}

model EventStaffInvite {
  id              String         @id @default(cuid())
  eventId         String
  email           String
  role            EventStaffRole @default(STAFF)
  token           String         @unique
  status          InviteStatus   @default(PENDING)
  message         String?
  createdByUserId String
  createdAt       DateTime       @default(now())
  expiresAt       DateTime?
  creator         User           @relation("EventStaffInviteCreator", fields: [createdByUserId], references: [id], onDelete: Cascade)
  event           Event          @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId])
  @@index([email])
  @@index([createdByUserId])
}

model EventStaffInviteLink {
  id              String         @id @default(cuid())
  eventId         String
  token           String         @unique
  role            EventStaffRole @default(STAFF)
  status          InviteStatus   @default(PENDING)
  maxUses         Int?
  uses            Int            @default(0)
  expiresAt       DateTime?
  note            String?
  createdByUserId String
  createdAt       DateTime       @default(now())
  creator         User           @relation("EventStaffInviteLinkCreator", fields: [createdByUserId], references: [id], onDelete: Cascade)
  event           Event          @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId])
  @@index([createdByUserId])
}

model EventStaffJoinRequest {
  id        String            @id @default(cuid())
  eventId   String
  userId    String
  message   String?
  status    JoinRequestStatus @default(PENDING)
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt
  event     Event             @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user      User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([eventId, userId])
  @@index([eventId])
  @@index([userId])
  @@index([status])
}

  // model EventInviteLink { id, eventId, token, note, maxUses, uses, expiresAt, createdById, createdAt }

model EventInviteLink {
    id              String         @id @default(cuid())
    eventId         String
    token           String         @unique
    status          InviteStatus   @default(PENDING)
    maxUses         Int?
    uses            Int            @default(0)
    expiresAt       DateTime?
    note            String?
    createdByUserId String
    createdAt       DateTime       @default(now())
    creator         User           @relation("EventInviteLinkCreator", fields: [createdByUserId], references: [id], onDelete: Cascade)
    event           Event          @relation(fields: [eventId], references: [id], onDelete: Cascade)

    @@index([eventId])
    @@index([createdByUserId])
  }

model EventEmailInvite {
  id              String         @id @default(cuid())
  eventId         String
  email           String
  token           String         @unique
  status          InviteStatus   @default(PENDING)
  message         String?
  createdByUserId String
  createdAt       DateTime       @default(now())
  expiresAt       DateTime?
  creator         User           @relation("EventEmailInviteCreator", fields: [createdByUserId], references: [id], onDelete: Cascade)
  event           Event          @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId])
  @@index([email])
  @@index([createdByUserId])
}

model EventAward {
  id        String   @id @default(cuid())
  eventId   String
  name      String
  blurb     String?
  order     Int      @default(0)
  createdAt DateTime @default(now())

  event     Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  assignments  AwardAssignment[]

  @@index([eventId])
  @@unique([eventId, name])
}

model AwardAssignment {
  id           String   @id @default(cuid())
  eventId      String
  awardId      String
  teamId       String?
  submissionId String?
  rank         Int?     // optional (1,2,3)
  createdAt    DateTime @default(now())

  event        Event      @relation(fields: [eventId], references: [id], onDelete: Cascade)
  award        EventAward @relation(fields: [awardId], references: [id], onDelete: Cascade)
  team         Team?      @relation(fields: [teamId], references: [id], onDelete: SetNull)
  submission   Submission?@relation(fields: [submissionId], references: [id], onDelete: SetNull)
 

  @@unique([eventId, awardId]) // if each award can only be assigned once
  @@index([eventId])
  @@index([awardId])
}

model SubmissionSchema {
  id      String @id @default(cuid())
  eventId String @unique
  fields  Json
  event   Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)
}

model Team {
  id                String            @id @default(cuid())
  eventId           String
  name              String
  blurb             String?
  track             String?
  lookingForMembers Boolean           @default(true)
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  moderationStatus  ModerationStatus  @default(ACTIVE)
  submissions       Submission[]
  event             Event             @relation(fields: [eventId], references: [id], onDelete: Cascade)
  auditLogs         TeamAuditLog[]
  invites           TeamInvite[]
  joinRequests      TeamJoinRequest[]
  members           TeamMember[]
  awardAssignments  AwardAssignment[]  // back relation to AwardAssignment

  @@index([eventId])
}

/// TeamMember design notes:
/// - eventId is stored directly to enforce:
/// one-team-per-user-per-event via @@unique([eventId, userId])
/// - LEADER transfer and kicking must be audited and optionally locked after event start.
model TeamMember {
  id      String   @id @default(cuid())
  eventId String
  teamId  String
  userId  String
  role    TeamRole @default(MEMBER)
  team    Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
  @@unique([eventId, userId])
  @@index([eventId])
  @@index([userId])
}

/// Email-only invites:
/// - Leader enters an email -> invite created with token
/// - Recipient signs in -> must match User.email -> accept via /.../team/invites/:token
/// - Acceptance must check:
/// - Event.maxTeamSize capacity
/// - TeamMember @@unique([eventId, userId]) (not already on a team)
/// - Optional lockTeamChangesAtStart policy if event has started
model TeamInvite {
  id              String       @id @default(cuid())
  eventId         String
  teamId          String
  email           String
  token           String       @unique
  status          InviteStatus @default(PENDING)
  message         String?
  createdByUserId String
  createdAt       DateTime     @default(now())
  expiresAt       DateTime?
  creator         User         @relation("TeamInviteCreator", fields: [createdByUserId], references: [id], onDelete: Cascade)
  event           Event        @relation(fields: [eventId], references: [id], onDelete: Cascade)
  team            Team         @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@index([eventId])
  @@index([teamId])
  @@index([email])
  @@index([createdByUserId], map: "TeamInvite_createdByUserId_fkey")
}

/// Join requests:
/// - A user sees a team on Find Teams -> sends request with message
/// - Team leader accepts/declines
/// - Acceptance must check:
/// - Event.maxTeamSize capacity
/// - TeamMember @@unique([eventId, userId]) (not already on a team)
/// - allowSelfJoinRequests policy
model TeamJoinRequest {
  id        String            @id @default(cuid())
  eventId   String
  teamId    String
  userId    String
  message   String?
  status    JoinRequestStatus @default(PENDING)
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt
  event     Event             @relation(fields: [eventId], references: [id], onDelete: Cascade)
  team      Team              @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user      User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
  @@index([eventId])
  @@index([teamId])
  @@index([userId])
}

/// Audit log:
/// - Write a row for sensitive actions:
/// - kicking
/// - leader transfer
/// - invite send/revoke/accept/decline
/// - join request lifecycle
/// - Helps prevent repudiation and enables organizer review.
model TeamAuditLog {
  id           String          @id @default(cuid())
  eventId      String
  teamId       String
  actorId      String?
  targetUserId String?
  action       TeamAuditAction
  meta         Json?
  createdAt    DateTime        @default(now())
  actor        User?           @relation("TeamAuditActor", fields: [actorId], references: [id])
  event        Event           @relation(fields: [eventId], references: [id], onDelete: Cascade)
  targetUser   User?           @relation("TeamAuditTarget", fields: [targetUserId], references: [id])
  team         Team            @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@index([eventId])
  @@index([teamId])
  @@index([actorId])
  @@index([targetUserId])
}

model Submission {
  id               String           @id @default(cuid())
  eventId          String
  teamId           String?
  authorId         String?
  status           SubmissionStatus @default(DRAFT)
  title            String
  description      String?
  content          Json?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  submittedAt      DateTime?
  moderationStatus ModerationStatus @default(ACTIVE)
  imageKeys        Json?
  videoKey         String?
  scores           Score[]
  author           User?            @relation("SubmissionAuthor", fields: [authorId], references: [id])
  event            Event            @relation(fields: [eventId], references: [id], onDelete: Cascade)
  team             Team?            @relation(fields: [teamId], references: [id])
  awardAssignments AwardAssignment[]  // âœ… back relation

  @@index([eventId])
  @@index([teamId])
  @@index([authorId])
}

model JudgeAssignment {
  id      String    @id @default(cuid())
  eventId String
  userId  String
  role    JudgeRole @default(JUDGE)
  event   Event     @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user    User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([eventId, userId])
  @@index([userId])
  @@index([eventId])
}

model Score {
  id           String     @id @default(cuid())
  submissionId String
  judgeId      String
  total        Float?
  breakdown    Json?
  feedback     String?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  judge        User       @relation("ScoreJudge", fields: [judgeId], references: [id], onDelete: Cascade)
  submission   Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  @@unique([submissionId, judgeId])
  @@index([submissionId])
  @@index([judgeId])
}

model Announcement {
  id        String   @id @default(cuid())
  eventId   String
  title     String
  bodyRich  Json?
  createdAt DateTime @default(now())
  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId])
}

model ContactMessage {
  id           String    @id @default(cuid())
  firstName    String
  lastName     String
  email        String
  phone        String?
  organization String?
  message      String
  createdAt    DateTime  @default(now())
  readAt       DateTime?

  @@index([email])
  @@index([createdAt])
}

model Sponsor {
  id          String                @id @default(cuid())
  name        String
  slug        String                @unique
  description String?
  logoKey     String?               @db.Text
  coverKey    String?               @db.Text
  createdAt   DateTime              @default(now())
  updatedAt   DateTime              @updatedAt
  websiteKey  String?
  createdById String?
  visibility  SponsorVisibility     @default(PRIVATE)
  eventLinks  EventSponsor[]
  orgLinks    OrganizationSponsor[]
  createdBy   User?                 @relation("SponsorCreatedBy", fields: [createdById], references: [id])

  @@index([createdById])
}

model OrganizationSponsor {
  id          String       @id @default(cuid())
  orgId       String
  sponsorId   String
  tier        SponsorTier  @default(COMMUNITY)
  isActive    Boolean      @default(true)
  displayName String?
  blurb       String?
  order       Int          @default(0)
  logoKey     String?      @db.Text
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  org         Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  sponsor     Sponsor      @relation(fields: [sponsorId], references: [id], onDelete: Cascade)

  @@unique([orgId, sponsorId])
  @@index([orgId])
  @@index([sponsorId])
  @@index([tier])
}

model EventSponsor {
  id          String      @id @default(cuid())
  eventId     String
  sponsorId   String
  tier        SponsorTier @default(COMMUNITY)
  isActive    Boolean     @default(true)
  displayName String?
  blurb       String?
  order       Int         @default(0)
  logoKey     String?     @db.Text
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  websiteKey  String?
  event       Event       @relation(fields: [eventId], references: [id], onDelete: Cascade)
  sponsor     Sponsor     @relation(fields: [sponsorId], references: [id], onDelete: Cascade)

  @@unique([eventId, sponsorId])
  @@index([eventId])
  @@index([sponsorId])
  @@index([tier])
}

enum OrgRole {
  OWNER
  ADMIN
  MEMBER
}

enum EventType {
  IDEATHON
  HACKATHON
}

enum EventStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum TeamRole {
  LEADER
  MEMBER
}

enum SubmissionStatus {
  DRAFT
  SUBMITTED
}

enum JudgeRole {
  JUDGE
  ADMIN_JUDGE
}

enum ParticipantStatus {
  REGISTERED
  WITHDRAWN
}

enum InviteStatus {
  PENDING
  ACCEPTED
  DECLINED
  REVOKED
  EXPIRED
}

enum JoinRequestStatus {
  PENDING
  ACCEPTED
  DECLINED
  CANCELLED
}

enum TeamAuditAction {
  TEAM_CREATED
  TEAM_UPDATED
  TEAM_DELETED
  INVITE_SENT
  INVITE_REVOKED
  INVITE_ACCEPTED
  INVITE_DECLINED
  JOIN_REQUEST_SENT
  JOIN_REQUEST_ACCEPTED
  JOIN_REQUEST_DECLINED
  JOIN_REQUEST_CANCELLED
  MEMBER_LEFT
  MEMBER_KICKED
  LEADER_TRANSFERRED
}

enum RegistrationRequestStatus { 
  PENDING 
  APPROVED 
  REJECTED 
  CANCELLED 
}

enum EventVisibility {
  PUBLIC_LISTED
  PUBLIC_UNLISTED
  PRIVATE
}

enum EventJoinMode {
  OPEN
  REQUEST
  INVITE_ONLY
}

enum ModerationStatus {
  ACTIVE
  FLAGGED
  HIDDEN
}

enum SponsorTier {
  TITLE
  PLATINUM
  GOLD
  SILVER
  BRONZE
  COMMUNITY
}

enum SponsorVisibility {
  PRIVATE
  PUBLIC
}

enum OrgJoinMode {
  INVITE_ONLY
  REQUEST
  OPEN
}

enum EventStaffJoinMode {
  INVITE_ONLY
  REQUEST
  OPEN
}

enum EventStaffRole {
  ADMIN
  REVIEWER
  MENTOR
  VOLUNTEER
  STAFF
}
